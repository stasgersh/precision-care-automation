{
  "id": "treatmentResponse.onco.extended",
  "items": [
    [
      {
        "key": "imagingReports",
        "query": {
          "from": "imagingReport",
          "filter": {
            "must": [
              {
                "date": {
                  "range": {
                    "lte": "now/d"
                  }
                }
              },
              {
                "attributes.status": {
                  "neq": "registered"
                }
              }
            ]
          },
          "dedup": true,
          "size": 200
        }
      }
    ],
    [
      {
        "key": "systemicTherapies",
        "query": {
          "from": "medication",
          "dedup": true,
          "size": 1000,
          "filter": {
            "must": [
              {
                "should": [
                  {
                    "subtypes": {
                      "eq": "chemo"
                    }
                  }
                ]
              },
              {
                "date": {
                  "range": {
                    "lte": "now/d"
                  }
                }
              }
            ]
          }
        },
        "postProcessing": [
          {
            "processor": {
              "name": "lastChemoMedications"
            }
          }
        ]
      }
    ],
    [
      {
        "key": "leastRecentRadiotherapyProcedure",
        "query": {
          "from": "radiotherapyProcedure",
          "filter": {
            "must": [
              {
                "date": {
                  "range": {
                    "lte": "now/d"
                  }
                }
              }
            ]
          },
          "dedup": true,
          "limit": 1,
          "sort": [
            {
              "date": "asc"
            }
          ]
        }
      },
      {
        "key": "surgicalProcedures",
        "query": {
          "from": "surgicalProcedure",
          "filter": {
            "must": [
              {
                "date": {
                  "range": {
                    "lte": "now/d"
                  }
                }
              }
            ]
          },
          "dedup": true
        }
      },
      {
        "key": "tumorReports",
        "query": {
          "from": [
            "imagingReport",
            "pathologyReport",
            "oncologyMDTReport",
            "oncologyOutpatientNote",
            "dischargeSummaryNote"
          ],
          "show": [
            "id",
            "type",
            "provenance",
            "date",
            "attributes.clpFindings"
          ],
          "filter": {
            "must": [
              {
                "date": {
                  "neq": null
                }
              },
              {
                "date": {
                  "range": {
                    "lte": "now/d"
                  }
                }
              },
              {
                "should": [
                  {
                    "attributes.$clpFindings.findings.PrimaryCancer_array.Measurements_object.Volume_float": {
                      "neq": null
                    }
                  },
                  {
                    "attributes.$clpFindings.findings.OtherBodyParts_array.Measurements_object.Volume_float": {
                      "neq": null
                    }
                  },
                  {
                    "attributes.$clpFindings.findings.Metastases_object.Tumors_array.Measurements_object.Volume_float": {
                      "neq": null
                    }
                  },
                  {
                    "attributes.$clpFindings.findings.Metastases_object.LymphNodes_array.Measurements_object.Volume_float": {
                      "neq": null
                    }
                  }
                ]
              },
              {
                "attributes.status": {
                  "neq": "registered"
                }
              }
            ]
          },
          "dedup": true,
          "sort": [
            {
              "date": "asc"
            }
          ]
        }
      }
    ],
    [
      {
        "key": "mostRecentRadiotherapyProcedure",
        "query": {
          "from": "radiotherapyProcedure",
          "filter": {
            "must": [
              {
                "date": {
                  "range": {
                    "lte": "now/d"
                  }
                }
              }
            ]
          },
          "dedup": true,
          "limit": 1,
          "sort": [
            {
              "date": "desc"
            }
          ]
        }
      },
      {
        "key": "mostRecentOncologyNote",
        "query": {
          "from": "oncologyOutpatientNote",
          "filter": {
            "must": [
              {
                "date": {
                  "range": {
                    "lte": "now/d"
                  }
                }
              }
            ]
          },
          "dedup": true,
          "limit": 1,
          "sort": [
            {
              "date": "desc"
            }
          ]
        }
      }
    ],
    [
      {
        "key": "trendableEntities",
        "query": {
          "from": [
            "generalTumorMarkerTestResult",
            "prostateTumorMarkerTestResult",
            "breastTumorMarkerTestResultCa153",
            "breastTumorMarkerTestResultCa125",
            "breastTumorMarkerTestResultCa2729",
            "weight"
          ],
          "filter": {
            "must": [
              {
                "must": [
                  {
                    "date": {
                      "neq": null
                    }
                  },
                  {
                    "date": {
                      "range": {
                        "lte": "now/d"
                      }
                    }
                  }
                ]
              },
              {
                "attributes.code.$coding": {
                  "neq": null
                }
              },
              {
                "attributes.trendKey": {
                  "neq": null
                }
              },
              {
                "attributes.valueQuantity.value": {
                  "neq": null
                }
              },
              {
                "attributes.status": {
                  "neq": "registered"
                }
              }
            ]
          },
          "dedup": true,
          "size": 1000,
          "show": [
            "id",
            "date",
            "attributes.code",
            "attributes.trendKey",
            "attributes.referenceRange",
            "attributes.valueQuantity"
          ]
        }
      }
    ]
  ]
}
